<!DOCTYPE html>
<html>
<head>
    <style>
        #chart-container {
            display: grid;
            grid-template-columns: 1fr;
            grid-gap: 20px;
        }
        canvas {
            width: 100% !important;
            max-width: 800px;
            height: auto !important;
        }
    </style>
</head>
<body>
    <div id="chart-container">
        <canvas id="chart-equation"></canvas>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.5.1/chart.min.js"></script>
    <script>
        window.onload = function() {
            var files = ['2018_Ocean.csv', '2019_Ocean.csv', '2020_Ocean.csv', '2021_Ocean.csv', '2022_Ocean.csv'];
            var dataByYear = {};

            files.forEach((file, index) => {
                Papa.parse(file, {
                    download: true,
                    complete: function(results) {
                        var data = results.data;

                        for (var i = 2; i < data.length; i++) {
                            if (data[i][1] === "속초연안") {
                                var DOIndex = data[1].indexOf("용존산소량DO (㎎/ℓ)");
                                var ChlIndex = data[1].indexOf("클로로필Chl-a (㎍/ℓ)");
                                var DINIndex = data[1].indexOf("용존무기질소DIN (㎍/ℓ)");
                                var DIPIndex = data[1].indexOf("용존무기인DIP (㎍/ℓ)");

                                if (DOIndex !== -1 && ChlIndex !== -1 && DINIndex !== -1 && DIPIndex !== -1) {
                                    var DOValue = parseFloat(data[i][DOIndex]);
                                    var ChlValue = parseFloat(data[i][ChlIndex]);
                                    var DINValue = parseFloat(data[i][DINIndex]);
                                    var DIPValue = parseFloat(data[i][DIPIndex]);

                                    DOValue = (DOValue / 9.1) * 100;
                                    var DoValue_DO, ChlValue_Chl, DINValue_DIN, DIPValue_DIP;

                                    if (DOValue > 90) {   
                                        DoValue_DO = 1;
                                    } else if (DOValue > 81) {   
                                        DoValue_DO = 2;
                                    } else if (DOValue > 67.5) {   
                                        DoValue_DO = 3;
                                    } else if (DOValue > 45) {   
                                        DoValue_DO = 4;
                                    } else {   
                                        DoValue_DO = 5;
                                    }

                                    if (ChlValue < 6.3) {   
                                        ChlValue_Chl = 1;
                                    } else if (ChlValue < 6.93) {   
                                        ChlValue_Chl = 2;
                                    } else if (ChlValue < 7.88) {   
                                        ChlValue_Chl = 3;
                                    } else if (ChlValue < 9.45) {   
                                        ChlValue_Chl = 4;
                                    } else {   
                                        ChlValue_Chl = 5;
                                    }

                                    if (DINValue < 220) {   
                                        DINValue_DIN = 1;
                                    } else if (DINValue < 242) {   
                                        DINValue_DIN = 2;
                                    } else if (DINValue < 275) {   
                                        DINValue_DIN = 3;
                                    } else if (DINValue < 330) {   
                                        DINValue_DIN = 4;
                                    } else {   
                                        DINValue_DIN = 5;
                                    }

                                    if (DIPValue < 35) {   
                                        DIPValue_DIP = 1;
                                    } else if (DIPValue < 38.50) {   
                                        DIPValue_DIP = 2;
                                    } else if (DIPValue < 43.75) {   
                                        DIPValue_DIP = 3;
                                    } else if (DIPValue < 52.50) {   
                                        DIPValue_DIP = 4;
                                    } else {   
                                        DIPValue_DIP = 5;
                                    }

                                    var result = 10 * DoValue_DO + 6 * ((ChlValue_Chl + 1) / 2) + 4 * ((DINValue_DIN + DIPValue_DIP) / 2);
                                    var result_re = result;

                                    if (result_re <= 23) {
                                        result_re = 1;
                                    } else if (result_re <= 33) {
                                        result_re = 2;
                                    } else if (result_re <= 46) {
                                        result_re = 3;
                                    } else if (result_re <= 59) {
                                        result_re = 4;
                                    } else {
                                        result_re = 5;
                                    }
                                    
                                    dataByYear[file.replace('_Ocean.csv', '')] = result_re;
                                }
                                break;
                            }
                        }

                        if (Object.keys(dataByYear).length === files.length) {
                            drawChart(dataByYear);
                        }
                    }
                });
            });
        };

        function drawChart(dataByYear) {
            var ctx = document.getElementById('chart-equation').getContext('2d');
            var labels = Object.keys(dataByYear);
            var data = Object.values(dataByYear);

            var chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '수질 평가 지수',
                        data: data,
                        fill: false,
                        borderColor: 'rgba(0, 0, 0, 1)',
                        tension: 0.1
                    }]
                },
                options: {
                    scales: {
                        x: {
                            type: 'category',
                            title: {
                                display: true,
                                text: '년도'
                            }
                        },
                        y: {
                            type: 'linear',
                            min: 0,
                            max: 5,
                            reverse: false,
                            ticks: {
                                stepSize: 1
                            },
                            title: {
                                display: true,
                                text: '등급'
                            }
                        }
                    },
                    plugins: {
                        filler: {
                            propagate: true
                        }
                    }
                },
                plugins: [{
                    afterDraw: chart => {
                        var ctx = chart.canvas.getContext('2d');
                        var yAxis = chart.scales['y'];
                        var chartArea = chart.chartArea;

                        ctx.save();

                        var gradientColor = [
                            'rgba(0, 0, 255, 0.3)',  // Blue
                            'rgba(144, 238, 144, 0.3)',  // Light green
                            'rgba(255, 255, 0, 0.3)',  // Yellow
                            'rgba(255, 165, 0, 0.3)',  // Orange
                            'rgba(255, 0, 0, 0.3)'  // Red
                        ];

                        for (let i = 0; i < 5; i++) {
                            ctx.fillStyle = gradientColor[i];
                            var y0 = yAxis.getPixelForValue(i);
                            var y1 = yAxis.getPixelForValue(i + 1);

                            ctx.fillRect(chartArea.left, Math.min(y0, y1), chartArea.width, Math.max(y0, y1) - Math.min(y0, y1));
                        }

                        ctx.restore();
                    }
                    
                }]
            });
        }
    </script>
</body>
</html>